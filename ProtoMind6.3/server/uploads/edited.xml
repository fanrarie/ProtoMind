<?xml version="1.0" encoding="UTF-8"?>
<TCPProtocolSpecification>
    <!-- TCP报文类型定义 -->
    <MessageTypes>
        <!-- SYN报文：用于建立连接 -->
        <MessageType name="SYN">
            <Fields>
                <Field name="SourcePort" type="uint16" description="源端口号"/>
                <Field name="DestinationPort" type="uint16" description="目标端口号"/>
                <Field name="SequenceNumber" type="uint32" description="序列号"/>
                <Field name="AcknowledgmentNumber" type="uint32" description="确认号"/>
                <Field name="DataOffset" type="uint4" description="数据偏移"/>
                <Field name="ControlFlags" type="uint6" description="控制标志">
                    <Flag name="SYN" bit="1" description="同步标志"/>
                </Field>
                <Field name="WindowSize" type="uint16" description="窗口大小"/>
                <Field name="Checksum" type="uint16" description="校验和"/>
                <Field name="UrgentPointer" type="uint16" description="紧急指针"/>
            </Fields>
        </MessageType>

        <!-- SYN-ACK报文：用于响应SYN报文 -->
        <MessageType name="SYN-ACK">
            <Fields>
                <Field name="SourcePort" type="uint16" description="源端口号"/>
                <Field name="DestinationPort" type="uint16" description="目标端口号"/>
                <Field name="SequenceNumber" type="uint32" description="序列号"/>
                <Field name="AcknowledgmentNumber" type="uint32" description="确认号"/>
                <Field name="DataOffset" type="uint4" description="数据偏移"/>
                <Field name="ControlFlags" type="uint6" description="控制标志">
                    <Flag name="SYN" bit="1" description="同步标志"/>
                    <Flag name="ACK" bit="1" description="确认标志"/>
                </Field>
                <Field name="WindowSize" type="uint16" description="窗口大小"/>
                <Field name="Checksum" type="uint16" description="校验和"/>
                <Field name="UrgentPointer" type="uint16" description="紧急指针"/>
            </Fields>
        </MessageType>

        <!-- ACK报文：用于确认数据接收 -->
        <MessageType name="ACK">
            <Fields>
                <Field name="SourcePort" type="uint16" description="源端口号"/>
                <Field name="DestinationPort" type="uint16" description="目标端口号"/>
                <Field name="SequenceNumber" type="uint32" description="序列号"/>
                <Field name="AcknowledgmentNumber" type="uint32" description="确认号"/>
                <Field name="DataOffset" type="uint4" description="数据偏移"/>
                <Field name="ControlFlags" type="uint6" description="控制标志">
                    <Flag name="ACK" bit="1" description="确认标志"/>
                </Field>
                <Field name="WindowSize" type="uint16" description="窗口大小"/>
                <Field name="Checksum" type="uint16" description="校验和"/>
                <Field name="UrgentPointer" type="uint16" description="紧急指针"/>
            </Fields>
        </MessageType>

        <!-- FIN报文：用于关闭连接 -->
        <MessageType name="FIN">
            <Fields>
                <Field name="SourcePort" type="uint16" description="源端口号"/>
                <Field name="DestinationPort" type="uint16" description="目标端口号"/>
                <Field name="SequenceNumber" type="uint32" description="序列号"/>
                <Field name="AcknowledgmentNumber" type="uint32" description="确认号"/>
                <Field name="DataOffset" type="uint4" description="数据偏移"/>
                <Field name="ControlFlags" type="uint6" description="控制标志">
                    <Flag name="FIN" bit="1" description="结束标志"/>
                    <Flag name="ACK" bit="1" description="确认标志"/>
                </Field>
                <Field name="WindowSize" type="uint16" description="窗口大小"/>
                <Field name="Checksum" type="uint16" description="校验和"/>
                <Field name="UrgentPointer" type="uint16" description="紧急指针"/>
            </Fields>
        </MessageType>

        <!-- DATA报文：用于传输数据 -->
        <MessageType name="DATA">
            <Fields>
                <Field name="SourcePort" type="uint16" description="源端口号"/>
                <Field name="DestinationPort" type="uint16" description="目标端口号"/>
                <Field name="SequenceNumber" type="uint32" description="序列号"/>
                <Field name="AcknowledgmentNumber" type="uint32" description="确认号"/>
                <Field name="DataOffset" type="uint4" description="数据偏移"/>
                <Field name="ControlFlags" type="uint6" description="控制标志">
                    <Flag name="ACK" bit="1" description="确认标志"/>
                </Field>
                <Field name="WindowSize" type="uint16" description="窗口大小"/>
                <Field name="Checksum" type="uint16" description="校验和"/>
                <Field name="UrgentPointer" type="uint16" description="紧急指针"/>
                <Field name="Payload" type="bytes" description="数据载荷"/>
            </Fields>
        </MessageType>
    </MessageTypes>

    <!-- TCP连接时序关系 -->
    <ConnectionSequence>
        <!-- 三次握手：建立连接 -->
        <Step name="ThreeWayHandshake">
            <Action name="SYN">
                <Sender>Client</Sender>
                <Receiver>Server</Receiver>
                <MessageType>SYN</MessageType>
            </Action>
            <Action name="SYN-ACK">
                <Sender>Server</Sender>
                <Receiver>Client</Receiver>
                <MessageType>SYN-ACK</MessageType>
            </Action>
            <Action name="ACK">
                <Sender>Client</Sender>
                <Receiver>Server</Receiver>
                <MessageType>ACK</MessageType>
            </Action>
        </Step>

        <!-- 数据传输 -->
        <Step name="DataTransfer">
            <Action name="SendData">
                <Sender>Client</Sender>
                <Receiver>Server</Receiver>
                <MessageType>DATA</MessageType>
            </Action>
            <Action name="AcknowledgeData">
                <Sender>Server</Sender>
                <Receiver>Client</Receiver>
                <MessageType>ACK</MessageType>
            </Action>
        </Step>

        <!-- 四次挥手：关闭连接 -->
        <Step name="FourWayHandshake">
            <Action name="FIN">
                <Sender>Client</Sender>
                <Receiver>Server</Receiver>
                <MessageType>FIN</MessageType>
            </Action>
            <Action name="ACK">
                <Sender>Server</Sender>
                <Receiver>Client</Receiver>
                <MessageType>ACK</MessageType>
            </Action>
            <Action name="FIN">
                <Sender>Server</Sender>
                <Receiver>Client</Receiver>
                <MessageType>FIN</MessageType>
            </Action>
            <Action name="ACK">
                <Sender>Client</Sender>
                <Receiver>Server</Receiver>
                <MessageType>ACK</MessageType>
            </Action>
        </Step>
    </ConnectionSequence>
</TCPProtocolSpecification>